---
title: "STAT504_Project_Shi"
author: "Seraphina Shi"
date: "2/10/2020"
output: html_document
---

# 0. Import Libararies 
```{r}
#install.packages("tidyverse")
#install.packages("corrplot")
library(tidyverse)
library(corrplot)
library(leaps)
library(MASS)
```

# 1. load the dataset and keep the variables that we are interested in
```{r}
#setwd("../STAT504_Final_Project") #Yijie
#setwd("C:/Users/Peter Liu/Desktop/STAT423/Project/STAT504_Final_Project") #Seraphina
setwd(".")  #Tianxin

rawdata <- read.csv(file="listings.csv")

rawdata <- rawdata[,c("price", "id", "name", "host_id", "host_name", "host_response_time", "host_response_rate", "neighbourhood_cleansed", "zipcode", "latitude", "longitude", "room_type", "accommodates", "bathrooms", "bedrooms", "beds", "amenities", "square_feet", "availability_365", "number_of_reviews", "review_scores_rating", "reviews_per_month", "instant_bookable", "cancellation_policy","minimum_nights", "cleaning_fee" )]
colnames(rawdata)
```


# 2. Data Cleaning  
## a. dropping duplicates  
```{r}
# checking duplicates
sum(duplicated(rawdata))  # there is no duplications in this data
```
## b. deal with missing values & any transformations?
```{r}
summary(rawdata) #check if there are any missing entries
```
  
Variables (host_response_time, host_response_rate, bathrooms, bedrooms, beds, square_feet, review_scores_rating, review_scores_value, reviews_per_month) has N/A values.  

```{r}
sample_n <- nrow(rawdata)
df <- rawdata
glimpse(df) #look variable names and types
```

### (1). clean "price", change from factor to dbl
```{r}
df$price <- suppressWarnings(as.double(substring(df$price, 2)))
```
```{r}
#check if price transformed properly
str(df$price)
summary(df$price) 
df$price[1:20]
rawdata$price[1:20] 
```
```{r}
# there is one NA in the price, check and replace it.
which(is.na(df$price)) 
rawdata$price[3123]
df$price[3123] = 1000.00
```
```{r}
summary(df$price)
```

### (2). Change id and host_id from int to fct
```{r}
df$id <- as.factor(df$id)
df$host_id <- as.factor(df$host_id)
```

### (3). clean host_response_time
```{r}
str(df$host_response_time)
```
```{r} 
df$host_response_time <- as.character(df$host_response_time)
str(df$host_response_time)
table(df$host_response_time)  
```
```{r}
df$host_response_time[df$host_response_time == ""] <- "0"
df$host_response_time[df$host_response_time == "N/A"] <- "N/A"
df$host_response_time[df$host_response_time == "within an hour"] <- "<= 1h"
df$host_response_time[df$host_response_time == "within a few hours"] <- "<= 5h"
df$host_response_time[df$host_response_time == "within a day"] <- "<= 24h"
df$host_response_time[df$host_response_time == "a few days or more"] <- "> 24h"
df$host_response_time <- as.factor(df$host_response_time)
table(df$host_response_time)
```

### (4). clean host_response_rate
```{r}
str(df$host_response_rate)
table(df$host_response_rate)
```
```{r}
df$host_response_rate <- as.character(df$host_response_rate)
# clean N/A and missing entries
df$host_response_rate[df$host_response_rate==""] <- "0%"
df$host_response_rate[df$host_response_rate=="N/A"] <- "0%"  
# convert to numbers
df$host_response_rate = substr(df$host_response_rate,1,nchar(df$host_response_rate)-1)
df$host_response_rate <- as.numeric(df$host_response_rate) / 100
summary(df$host_response_rate)
```

### (5) clean bathrooms, bedrooms, beds (fill the missing entries with 0)   

```{r}
df$bathrooms[is.na(df$bathrooms)] <- 0
df$bedrooms[is.na(df$bedrooms)] <- 0
df$beds[is.na(df$beds)] <- 0
summary(df$bathrooms)
summary(df$bedrooms)
summary(df$beds)
```


### (6) clean amenities
```{r}
df$amenities <- as.character(df$amenities)
```
```{r}
# Free Parking on Premises
parking <- rep(0, sample_n)
parking[str_detect(df$amenities, regex("Free Parking", ignore_case=T))] <- 1
parking <- as.factor(parking)
table(parking)
df <- cbind(df, parking)
```
```{r}
# Washer, Dryer 
washer <- rep(0,sample_n)
washer[str_detect(df$amenities, regex("Washer", ignore_case=T))] <- 1
washer <- as.factor(washer)
table(washer)
df <- cbind(df, washer)
```
```{r}
# 24-Hour Check-in
checkin24 <- rep(0,sample_n)
checkin24[str_detect(df$amenities, regex("24-Hour Check-in", ignore_case=T))] <- 1
checkin24 <- as.factor(checkin24)
table(checkin24)
df <- cbind(df, checkin24)
```
```{r}
# Pets Allowed
Pets_Allowed <- rep(0,sample_n)
Pets_Allowed[str_detect(df$amenities, regex("Pets Allowed", ignore_case=T))] <- 1
Pets_Allowed <- as.factor(Pets_Allowed)
table(Pets_Allowed)
df <- cbind(df, Pets_Allowed)
```

### (7) clean square_feet
```{r}
sum(is.na(df$square_feet))/sample_n
```
97.5% of observations do bot have the square feet, so we won't use this variable in our analysis. 

### (8) clean review_scores_rating (fill the missing entries with 0, and change to quantiles, then treat it as factors)
```{r}
df$review_scores_rating[is.na(df$review_scores_rating)] <- 0
table(df$review_scores_rating)
summary(df$review_scores_rating)
```
```{r}
i = 0
for (i in 1:length(df$review_scores_rating)) {
  if (df$review_scores_rating[i] < 87) {df$review_rating[i] <- "bad"
  } else 
  {
    if (df$review_scores_rating[i] >= 87 & df$review_scores_rating[i] < 95) {
      df$review_rating[i] <- "fair"
    } else 
    {if (df$review_scores_rating[i] >= 95 & df$review_scores_rating[i] < 98) {
      df$review_rating[i] <- "good"
    } else {df$review_rating[i] <- "excellent"}
    }}
  i = i + 1
  
}

table(df$review_rating)
df$review_rating <- as.factor(df$review_rating)
```

### (9) clean reviews_per_month
```{r}
df$reviews_per_month[df$reviews_per_month == ""] <- 0

df$reviews_per_month[is.na(df$reviews_per_month) == TRUE] <- 0

summary(df$reviews_per_month)
```

### (10) cleaning-fee
```{r}
df$cleaning_fee <- suppressWarnings(as.double(substring(df$cleaning_fee, 2)))
df$cleaning_fee[is.na(df$cleaning_fee)]=0
#summary(df$cleaning_fee)
```
### (11) cleaning neighbourhood
```{r}

neighbor = c("Alki", "Arbor Heights", "Belltown", "Bitter Lake", "Briarcliff","Broadview","Broadway","Central Business District","Columbia City","Crown Hill","Dunlap","East Queen Anne","First Hill", "Greenwood","Haller Lake","Industrial District","International District","Lower Queen Anne","Maple Leaf","Montlake","North College Park","North Delridge","Pike-Market","Pinehurst","Pioneer Square" ,"Portage Bay","Rainier Beach")


list_neighbor = as.character( df$neighbourhood_cleansed )
list_neighbor[list_neighbor != "Alki" & list_neighbor != "Arbor Heights" & list_neighbor != "Bitter Lake" & list_neighbor != "Briarcliff" & list_neighbor != "Broadview" & list_neighbor != "Broadway" & list_neighbor != "Central Business District" & list_neighbor != "Columbia City" & list_neighbor != "Crown Hill" & list_neighbor != "Dunlap" & list_neighbor != "Greenwood" & list_neighbor != "Haller Lake" & list_neighbor != "Industrial District" & list_neighbor != "International District" & list_neighbor != "Lower Queen Anne" & list_neighbor != "Maple Leaf" & list_neighbor != "Montlake" & list_neighbor != "North College Park" & list_neighbor != "North Delridge" & list_neighbor != "Pike-Market" & list_neighbor != "Pinehurst" & list_neighbor != "Pioneer Square" & list_neighbor != "Portage Bay" & list_neighbor != "Rainier Beach"   ] <- "Other"

df$neighbourhood_group = as.factor(list_neighbor)
```

# 3. Data visualization 
Things to think about while doing data visualization:  
    a.       outliers?  
    b. variable selection 
       plot variables  
       linear?  
    c. variables independent?   
       pair plots?  
       correlation between variables?  

Interested Vairables:  
price ~  
"host_response_rate", "neighbourhood_cleansed",  "room_type", "accommodates", "bathrooms", "bedrooms", "beds", "availability_365", "number_of_reviews", "review_scores_rating", "reviews_per_month", "instant_bookable", "cancellation_policy", "minimum_nights", "cleaning_fee", "parking", "washer", "checkin24", "Pets_Allowed", "review_rating".  

(21 predictors at the start)
(originally, we are also interested in square-feet as a predictor, but more than 95% of observations don't have this information. Then we excluded it.)



```{r}
hist(df$price, breaks=50)
```
Bell-shape, unimodal, almost symmetricc (right-skewed)

```{r}
#glimpse(df)
```

```{r}
(cor(df[,c("price", "host_response_rate", "accommodates", "bathrooms", "bedrooms", "beds", "number_of_reviews", "review_scores_rating", "reviews_per_month", "minimum_nights", "cleaning_fee")]))
```
```{r}
plot(df[,c("price", "host_response_rate", "accommodates", "bathrooms", "bedrooms", "beds", "number_of_reviews", "review_scores_rating", "reviews_per_month", "minimum_nights", "cleaning_fee")])
```
```{r}
corrplot(cor(df[,c("price", "host_response_rate", "accommodates", "bathrooms", "bedrooms", "beds", "number_of_reviews", "review_scores_rating", "reviews_per_month", "minimum_nights", "cleaning_fee","availability_365")]), method="circle")
```
We can see that accommodates, bathrooms, bedrooms, beds, and cleaning-fee are multicollinear, so we decide to exclude all of them except accmomodates in our model (excluding bathrooms, bedrooms, beds, and cleaning-fee). 

Revire-per-month and number-of-reviews are colinear, so we exclude number of reviews in our model.

review-score-rating is highly correlated with review-rating, keep review0rating.

Minimun nights have too many zeros, we are not interested in it anymore .
```{r}
corrplot(cor(df[,c("price", "host_response_rate", "accommodates",  "reviews_per_month", "availability_365")]), method="circle")
```
```{r}
plot(df[,c("price", "host_response_rate", "accommodates", "reviews_per_month","availability_365")])
```


price ~  
"host_response_rate", "neighbourhood_group",  "room_type", "accommodates",  "availability_365",  "reviews_per_month", "instant_bookable", "cancellation_policy", "minimum_nights", "parking", "washer", "checkin24", "Pets_Allowed", "review_rating".


```{r}
#histogram numerical variable 
hist(df$host_response_rate, breaks=50, main="host_response_rate")
hist(df$accommodates, breaks=50,  main="ccommodates")
hist(df$reviews_per_month, breaks=50, main="reviews_per_month")
hist(df$minimum_nights, breaks=50, main="minimum_nights")
hist(df$availability_365, breaks=50, main="availability_365")

#histogram categorical variable 
plot(df$neighbourhood_group, main="Neighbourhood")
plot(df$washer,main="Washer")
plot(df$parking,main="Parking")
plot(df$room_type,main="Room Type")
plot(df$checkin24,main="24 hours check-in")
plot(df$cancellation_policy,main="cancellation policy")
plot(df$Pets_Allowed,main="Pets Allowed")
plot(df$instant_bookable,main="Instant Bookable")
plot(df$review_rating, main="review rating")
```


```{r}
corrplot(cor(df[,c("price", "host_response_rate", "accommodates",  "reviews_per_month", "minimum_nights")]), method="circle")
```

# 4. Regression  
  model selection

```{r}
df_reg <- df[,c("price",  "host_response_rate", "neighbourhood_group", "room_type","accommodates", "availability_365", "reviews_per_month", "instant_bookable", "cancellation_policy", "parking", "washer", "checkin24", "Pets_Allowed", "review_rating")]

fit1 = lm(price ~  host_response_rate + neighbourhood_group + room_type+accommodates + availability_365 + reviews_per_month+ instant_bookable + cancellation_policy + parking + washer + checkin24 + Pets_Allowed + review_rating, data=df_reg)
summary(fit1)
```

```{r}
boxcox(fit1)$x[which.max(boxcox(fit1)$y)]
boxcox(fit1)
```

```{r}
fit2 <- lm(price^(-0.2) ~ host_response_rate + neighbourhood_group + accommodates * room_type * reviews_per_month + availability_365 + instant_bookable + cancellation_policy + parking + washer + checkin24 + Pets_Allowed + review_rating, data = df_reg)
#neighbourhood_group + accommodates * room_type * reviews_per_month + host_response_rate + review_rating + availability_365 + cancellation_policy + checkin24 + instant_bookable,
summary(fit2)
plot(fit2)
```



```{r}
n_sample <- nrow(df_reg)
fit0 <- lm(price^(-0.2)~1,data=df_reg)
# BIC: step(fit0, dir="forward", k=log(n_sample),scope=list(upper=fit2,lower=fit0))
step(fit0, dir="forward",scope=list(upper=fit2,lower=fit0))


```

```{r}
subsets <- regsubsets(price^(-0.2) ~ host_response_rate + neighbourhood_group + accommodates * room_type * reviews_per_month + availability_365 + instant_bookable + cancellation_policy + parking + washer + checkin24 + Pets_Allowed + review_rating, data = df_reg,nvmax = 20)
summary(subsets)

bsubsets <- summary(subsets)
par(mfrow = c(2,2))
plot(bsubsets$bic) # BIC, AIC not implemented :(
plot(bsubsets$cp) # Mallow's Cp
plot(bsubsets$adjr2) # adjusted R squared
plot(bsubsets$rsq) # R squared

#BIC(lm(FoHF ~ FIA + ED + GM + CTA,data = FoHF))

```


```{r}
# linear regression derived from subsets
fit3 <- lm(price^(-0.2) ~ neighbourhood_group + accommodates + room_type + reviews_per_month + accommodates:room_type + accommodates:reviews_per_month + host_response_rate + review_rating + availability_365 + checkin24, data = df_reg)
#neighbourhood_group + accommodates * room_type * reviews_per_month + host_response_rate + review_rating + availability_365 + cancellation_policy + checkin24 + instant_bookable,
summary(fit3)
plot(fit3)

```

```{r}
# final decision
# linear regression derived from AIC forward
fit4 <- lm(formula = price^(-0.2) ~ accommodates + room_type + neighbourhood_group + 
    reviews_per_month + host_response_rate + review_rating + 
    availability_365 + checkin24 + cancellation_policy + instant_bookable + 
    accommodates:reviews_per_month + accommodates:room_type, 
    data = df_reg)

summary(fit4)
plot(fit4)
```


